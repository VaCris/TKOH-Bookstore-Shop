{% extends 'base.html.twig' %}

{% block title %}Carrito de Compras - TKOH Bookstore{% endblock %}

{% block body %}
<div class="container my-5">

    {# Título #}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="bi bi-cart-fill"></i>
            Mi Carrito de Compras
        </h1>
        <a href="{{ path('catalog_index') }}" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left"></i> Seguir Comprando
        </a>
    </div>

    {% if cart is empty %}
        {# Carrito vacío #}
        <div class="text-center py-5">
            <div class="empty-cart">
                <i class="bi bi-cart-x display-1 text-muted mb-4"></i>
                <h3 class="mb-3">Tu carrito está vacío</h3>
                <p class="text-muted mb-4">
                    ¡Agrega algunos libros para comenzar!
                </p>
                <a href="{{ path('catalog_index') }}" class="btn btn-primary btn-lg">
                    <i class="bi bi-search"></i> Explorar Catálogo
                </a>
            </div>
        </div>
    {% else %}
        {# Carrito con items #}
        <div class="row">
            {# Lista de items #}
            <div class="col-lg-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-bag-check"></i>
                            Productos ({{ itemCount }})
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Producto</th>
                                        <th class="text-center">Precio</th>
                                        <th class="text-center" style="width: 150px;">Cantidad</th>
                                        <th class="text-end">Subtotal</th>
                                        <th class="text-center" style="width: 80px;">Acción</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in cart %}
                                        <tr id="cart-item-{{ item.isbn }}">
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <img
                                                        src="{{ item.imagen ?? 'https://via.placeholder.com/60x90?text=Sin+Portada' }}"
                                                        alt="{{ item.titulo }}"
                                                        class="rounded me-3"
                                                        style="width: 60px; height: 90px; object-fit: cover;"
                                                        onerror="this.src='https://via.placeholder.com/60x90?text=Sin+Portada'"
                                                    >
                                                    <div>
                                                        <h6 class="mb-1">
                                                            <a href="{{ path('catalog_book_detail', {isbn: item.isbn}) }}"
                                                               class="text-decoration-none text-dark">
                                                                {{ item.titulo }}
                                                            </a>
                                                        </h6>
                                                        <small class="text-muted">
                                                            {{ item.autor }}
                                                        </small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="text-center align-middle">
                                                <strong class="text-success">
                                                    ${{ item.precio|number_format(2) }}
                                                </strong>
                                            </td>
                                            <td class="text-center align-middle">
                                                <div class="input-group input-group-sm" style="max-width: 130px; margin: 0 auto;">
                                                    <button
                                                        class="btn btn-outline-secondary"
                                                        onclick="updateQuantity('{{ item.isbn }}', {{ item.cantidad - 1 }})">
                                                        <i class="bi bi-dash"></i>
                                                    </button>
                                                    <input
                                                        type="number"
                                                        class="form-control text-center"
                                                        id="quantity-{{ item.isbn }}"
                                                        value="{{ item.cantidad }}"
                                                        min="1"
                                                        max="10"
                                                        readonly
                                                    >
                                                    <button
                                                        class="btn btn-outline-secondary"
                                                        onclick="updateQuantity('{{ item.isbn }}', {{ item.cantidad + 1 }})">
                                                        <i class="bi bi-plus"></i>
                                                    </button>
                                                </div>
                                            </td>
                                            <td class="text-end align-middle">
                                                <strong id="subtotal-{{ item.isbn }}">
                                                    ${{ (item.precio * item.cantidad)|number_format(2) }}
                                                </strong>
                                            </td>
                                            <td class="text-center align-middle">
                                                <button
                                                    class="btn btn-sm btn-outline-danger"
                                                    onclick="removeItem('{{ item.isbn }}')"
                                                    title="Eliminar">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                {# Botón vaciar carrito #}
                <form method="post" action="{{ path('cart_clear') }}"
                      onsubmit="return confirm('¿Estás seguro de vaciar el carrito?')">
                    <button type="submit" class="btn btn-outline-danger">
                        <i class="bi bi-trash"></i> Vaciar Carrito
                    </button>
                </form>
            </div>

            {# Resumen del pedido #}
            <div class="col-lg-4">
                <div class="card shadow-sm sticky-top" style="top: 20px;">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-receipt"></i>
                            Resumen del Pedido
                        </h5>
                    </div>
                    <div class="card-body">
                        {# Subtotal #}
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal ({{ itemCount }} items):</span>
                            <strong id="cart-subtotal">${{ total|number_format(2) }}</strong>
                        </div>

                        {# Envío #}
                        <div class="d-flex justify-content-between mb-2">
                            <span>Envío:</span>
                            {% if total >= 50 %}
                                <strong class="text-success">GRATIS</strong>
                            {% else %}
                                <strong>$5.00</strong>
                            {% endif %}
                        </div>

                        <hr>

                        {# Total #}
                        <div class="d-flex justify-content-between mb-3">
                            <h5 class="mb-0">Total:</h5>
                            <h4 class="mb-0 text-success" id="cart-total">
                                ${{ (total >= 50 ? total : total + 5)|number_format(2) }}
                            </h4>
                        </div>

                        {% if total < 50 %}
                            <div class="alert alert-info small mb-3">
                                <i class="bi bi-info-circle"></i>
                                Agrega ${{ (50 - total)|number_format(2) }} más para envío gratis
                            </div>
                        {% endif %}

                        {# Botón proceder al pago #}
                        {% if app.session.get('jwt_token') %}
                            <a href="{{ path('checkout_index') }}" class="btn btn-success btn-lg w-100 mb-2">
                                <i class="bi bi-credit-card"></i> Proceder al Pago
                            </a>
                        {% else %}
                            <a href="{{ path('auth_login') }}?_target_path={{ path('checkout_index') }}"
                               class="btn btn-success btn-lg w-100 mb-2">
                                <i class="bi bi-box-arrow-in-right"></i> Iniciar Sesión para Comprar
                            </a>
                            <p class="text-center small text-muted mb-0">
                                ¿No tienes cuenta?
                                <a href="{{ path('auth_register') }}">Regístrate</a>
                            </p>
                        {% endif %}

                        {# Seguridad #}
                        <div class="text-center mt-3">
                            <small class="text-muted">
                                <i class="bi bi-shield-check text-success"></i>
                                Compra 100% segura
                            </small>
                        </div>
                    </div>
                </div>

                {# Métodos de pago aceptados #}
                <div class="card shadow-sm mt-3">
                    <div class="card-body text-center">
                        <small class="text-muted d-block mb-2">Aceptamos:</small>
                        <div class="d-flex justify-content-center gap-2">
                            <i class="bi bi-credit-card fs-4 text-primary"></i>
                            <i class="bi bi-paypal fs-4" style="color: #0070ba;"></i>
                            <i class="bi bi-stripe fs-4" style="color: #635bff;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

</div>

<script>
// Actualizar cantidad
function updateQuantity(isbn, newQuantity) {
    if (newQuantity < 1) {
        if (confirm('¿Eliminar este libro del carrito?')) {
            removeItem(isbn);
        }
        return;
    }

    if (newQuantity > 10) {
        alert('Máximo 10 unidades por libro');
        return;
    }

    fetch('{{ path('cart_update') }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            isbn: isbn,
            quantity: newQuantity
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Recargar la página para actualizar precios
            location.reload();
        } else {
            alert('Error al actualizar cantidad');
        }
    });
}

// Eliminar item
function removeItem(isbn) {
    fetch('{{ path('cart_remove') }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ isbn: isbn })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Eliminar visualmente
            const row = document.getElementById('cart-item-' + isbn);
            row.style.transition = 'opacity 0.3s';
            row.style.opacity = '0';

            setTimeout(() => {
                location.reload();
            }, 300);
        } else {
            alert('Error al eliminar item');
        }
    });
}

// Actualizar badge del carrito en navbar
function updateCartBadge() {
    fetch('{{ path('cart_count') }}')
        .then(response => response.json())
        .then(data => {
            document.getElementById('cart-badge').textContent = data.count;
        });
}

// Actualizar al cargar
updateCartBadge();
</script>

<style>
.empty-cart i {
    font-size: 8rem;
}

.cart-item:hover {
    background-color: #f8f9fa;
}

@media (max-width: 768px) {
    .table td, .table th {
        padding: 0.5rem;
        font-size: 0.9rem;
    }
}
</style>
{% endblock %}
