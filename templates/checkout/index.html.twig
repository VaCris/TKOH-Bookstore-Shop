{% extends 'base.html.twig' %}

{% block title %}Checkout - TKOH Bookstore{% endblock %}

{% block body %}
<div class="container my-5">

    <h1 class="mb-4">
        <i class="bi bi-credit-card"></i>
        Finalizar Compra
    </h1>

    <div class="row">
        {# Resumen del pedido #}
        <div class="col-lg-7">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-bag-check"></i>
                        Tu Pedido
                    </h5>
                </div>
                <div class="card-body">
                    {% for item in cart.items %}
                        <div class="d-flex align-items-center mb-3 pb-3 border-bottom">
                            <img
                                src="{{ item.imagen }}"
                                alt="{{ item.titulo }}"
                                class="rounded me-3"
                                style="width: 60px; height: 90px; object-fit: cover;"
                            >
                            <div class="flex-grow-1">
                                <h6 class="mb-1">{{ item.titulo }}</h6>
                                <small class="text-muted">{{ item.autor }}</small>
                                <p class="mb-0 mt-1">
                                    {{ item.cantidad }} × ${{ item.precio_unitario|number_format(2) }}
                                </p>
                            </div>
                            <div class="text-end">
                                <strong>${{ item.subtotal|number_format(2) }}</strong>
                            </div>
                        </div>
                    {% endfor %}

                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <strong>${{ cart.subtotal|number_format(2) }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Envío:</span>
                        {% if cart.shipping == 0 %}
                            <strong class="text-success">GRATIS</strong>
                        {% else %}
                            <strong>${{ cart.shipping|number_format(2) }}</strong>
                        {% endif %}
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <h5>Total:</h5>
                        <h4 class="text-success">${{ cart.total|number_format(2) }}</h4>
                    </div>
                </div>
            </div>
        </div>

        {# Método de pago #}
        <div class="col-lg-5">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-credit-card-2-front"></i>
                        Pago Seguro
                    </h5>
                </div>
                <div class="card-body text-center">
                    <div class="mb-4">
                        <img src="https://stripe.com/img/v3/payments/overview/logos/powered-by-stripe.svg"
                             alt="Powered by Stripe"
                             style="height: 40px;">
                    </div>

                    <p class="text-muted small mb-4">
                        Serás redirigido a Stripe para completar tu pago de forma segura.
                        Podrás ingresar tu dirección de envío y datos de pago.
                    </p>

                    <button
                        id="checkout-button"
                        class="btn btn-success btn-lg w-100"
                        onclick="createCheckoutSession()">
                        <i class="bi bi-lock-fill"></i>
                        Proceder al Pago
                    </button>

                    <div class="text-center mt-3">
                        <small class="text-muted">
                            <i class="bi bi-shield-check text-success"></i>
                            Pago 100% seguro
                        </small>
                    </div>

                    {# Tarjetas de prueba (solo en test mode) #}
                    <div class="alert alert-warning mt-4 text-start small">
                        <strong><i class="bi bi-info-circle"></i> Modo Test</strong>
                        <p class="mb-1 mt-2">Tarjetas de prueba:</p>
                        <ul class="mb-0 ps-3">
                            <li><strong>Éxito:</strong> 4242 4242 4242 4242</li>
                            <li><strong>Rechazo:</strong> 4000 0000 0000 0002</li>
                            <li>Fecha: Cualquier futura | CVV: 123</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="text-center mt-3">
                <a href="{{ path('cart_index') }}" class="text-decoration-none">
                    <i class="bi bi-arrow-left"></i> Volver al carrito
                </a>
            </div>
        </div>
    </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
const stripe = Stripe('{{ stripePublicKey }}');

async function createCheckoutSession() {
    const button = document.getElementById('checkout-button');
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creando sesión...';

    try {
        const response = await fetch('{{ path('checkout_create_session') }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const session = await response.json();

        if (session.error) {
            throw new Error(session.error);
        }

        // Redirigir a Stripe Checkout
        window.location.href = session.url;

    } catch (error) {
        alert('Error: ' + error.message);
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-lock-fill"></i> Proceder al Pago';
    }
}
</script>
{% endblock %}
